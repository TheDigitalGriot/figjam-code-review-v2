<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Code Review Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div id="app-container"></div>
    
    <!-- Import the main UI components -->
    <script type="module">
      // Since we're in a Figma plugin environment, we need to handle module imports differently
      // This is a simplified loader that will work with the plugin's constraints
      
      // Store and WebSocket classes (simplified versions)
      class SimpleStore {
        constructor() {
          this.state = {
            diagram: null,
            directoryTree: null,
            selectedFilePath: null,
            openFile: null,
            comments: [],
            isConnected: false,
            channelName: null
          };
          this.listeners = [];
        }

        subscribe(callback) {
          this.listeners.push(callback);
          return () => {
            const index = this.listeners.indexOf(callback);
            if (index > -1) this.listeners.splice(index, 1);
          };
        }

        notify() {
          this.listeners.forEach(listener => listener(this.state));
        }

        setConnectionState(isConnected, channelName) {
          this.state.isConnected = isConnected;
          this.state.channelName = channelName;
          this.notify();
        }

        setDiagram(diagram) {
          this.state.diagram = diagram;
          this.notify();
        }

        setDirectoryTree(tree) {
          this.state.directoryTree = tree;
          this.notify();
        }

        selectFile(filePath) {
          this.state.selectedFilePath = filePath;
          this.notify();
        }

        addComment(comment) {
          const newComment = {
            ...comment,
            id: `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            createdAt: new Date().toISOString()
          };
          this.state.comments.push(newComment);
          this.notify();
          return newComment;
        }
      }

      // Simple WebSocket client
      class SimpleWebSocketClient {
        constructor() {
          this.ws = null;
          this.channelName = null;
        }

        async connect(url, channel) {
          return new Promise((resolve, reject) => {
            try {
              // In Figma plugin, we'll communicate through postMessage
              parent.postMessage({ 
                pluginMessage: { 
                  type: 'websocket_connect', 
                  url, 
                  channel 
                } 
              }, '*');
              
              this.channelName = channel;
              resolve();
            } catch (error) {
              reject(error);
            }
          });
        }

        generateUml(rootPath, maxFiles = 500) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'generate_uml', 
              rootPath, 
              maxFiles 
            } 
          }, '*');
        }

        send(message) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'websocket_message', 
              message 
            } 
          }, '*');
        }
      }

      // Initialize
      const store = new SimpleStore();
      const wsClient = new SimpleWebSocketClient();

      // Simple UI implementation
      function createCodeReviewUI() {
        const container = document.getElementById('app-container');
        
        container.innerHTML = `
          <style>
            * { box-sizing: border-box; }
            body {
              margin: 0;
              padding: 0;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #1e1e1e;
              color: #e0e0e0;
              height: 100vh;
              overflow: hidden;
            }
            
            .app-container {
              display: flex;
              flex-direction: column;
              height: 100vh;
            }
            
            .app-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 16px;
              background: #2d2d2d;
              border-bottom: 1px solid #555;
              flex-shrink: 0;
            }
            
            .app-header h2 {
              margin: 0;
              font-size: 16px;
              font-weight: 600;
              color: #fff;
            }
            
            .connection-status {
              display: flex;
              align-items: center;
              gap: 6px;
              font-size: 12px;
            }
            
            .status-indicator {
              width: 8px;
              height: 8px;
              border-radius: 50%;
              background: #ef4444;
            }
            
            .status-indicator.connected {
              background: #4ade80;
            }
            
            .app-body {
              flex: 1;
              display: grid;
              grid-template-columns: 200px 1fr 250px;
              grid-template-rows: 1fr 200px;
              gap: 1px;
              background: #555;
              overflow: hidden;
            }
            
            .panel {
              background: #2d2d2d;
              display: flex;
              flex-direction: column;
              overflow: hidden;
            }
            
            .panel-header {
              padding: 8px 12px;
              background: #3d3d3d;
              font-size: 12px;
              font-weight: 600;
              border-bottom: 1px solid #555;
            }
            
            .panel-content {
              flex: 1;
              overflow: auto;
              padding: 8px;
            }
            
            .directory-tree {
              grid-column: 1;
              grid-row: 1 / 3;
            }
            
            .diagram-panel {
              grid-column: 2;
              grid-row: 1;
            }
            
            .code-review-panel {
              grid-column: 3;
              grid-row: 1;
            }
            
            .comment-log-panel {
              grid-column: 2 / 4;
              grid-row: 2;
            }
            
            .empty-state {
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: #888;
              font-style: italic;
            }
            
            .file-item {
              padding: 4px 8px;
              cursor: pointer;
              border-radius: 3px;
              font-size: 13px;
            }
            
            .file-item:hover {
              background: #3d3d3d;
            }
            
            .file-item.selected {
              background: #18a0fb;
              color: white;
            }
            
            .quick-actions {
              position: fixed;
              bottom: 16px;
              right: 16px;
              display: flex;
              gap: 8px;
              z-index: 1000;
            }
            
            .action-btn {
              padding: 8px 12px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 12px;
              background: #18a0fb;
              color: white;
              transition: background-color 0.2s;
            }
            
            .action-btn:hover {
              background: #0d8ee0;
            }
            
            .comment-item {
              margin-bottom: 12px;
              padding: 8px;
              background: #3d3d3d;
              border-radius: 4px;
              border-left: 3px solid #18a0fb;
            }
            
            .comment-header {
              font-size: 11px;
              color: #888;
              margin-bottom: 4px;
            }
            
            .comment-text {
              font-size: 13px;
              line-height: 1.4;
            }

            #diagram-canvas {
              width: 100%;
              height: 100%;
              background: #1e1e1e;
              cursor: crosshair;
            }
          </style>
          
          <div class="app-container">
            <div class="app-header">
              <h2>üîç Code Review Workspace</h2>
              <div class="connection-status">
                <span class="status-indicator" id="status-indicator"></span>
                <span class="status-text" id="status-text">Connecting...</span>
              </div>
            </div>
            
            <div class="app-body">
              <!-- Directory Tree -->
              <div class="panel directory-tree">
                <div class="panel-header">üìÅ Directory</div>
                <div class="panel-content" id="directory-content">
                  <div class="empty-state">No directory loaded</div>
                </div>
              </div>
              
              <!-- UML Diagram -->
              <div class="panel diagram-panel">
                <div class="panel-header">üèóÔ∏è UML Diagram</div>
                <div class="panel-content">
                  <canvas id="diagram-canvas"></canvas>
                </div>
              </div>
              
              <!-- Code Review -->
              <div class="panel code-review-panel">
                <div class="panel-header">üìù Code Review</div>
                <div class="panel-content" id="code-content">
                  <div class="empty-state">Select a file to review</div>
                </div>
              </div>
              
              <!-- Comment Log -->
              <div class="panel comment-log-panel">
                <div class="panel-header">üí¨ Comments (<span id="comment-count">0</span>)</div>
                <div class="panel-content" id="comment-log">
                  <div class="empty-state">No comments yet</div>
                </div>
              </div>
            </div>
            
            <div class="quick-actions">
              <button class="action-btn" onclick="generateUML()">
                ‚öôÔ∏è Generate UML
              </button>
              <button class="action-btn" onclick="exportComments()">
                üì§ Export
              </button>
              <button class="action-btn" onclick="switchToWidget()" title="Switch to embedded widget mode for FigJam">
                üîó Create Widget
              </button>
            </div>
          </div>
        `;
      }

      // UI update functions
      function updateConnectionStatus(isConnected, channelName) {
        const indicator = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');
        
        if (isConnected) {
          indicator.className = 'status-indicator connected';
          text.textContent = `Connected to ${channelName || 'channel'}`;
        } else {
          indicator.className = 'status-indicator';
          text.textContent = 'Disconnected';
        }
      }

      function updateDirectoryTree(tree) {
        const container = document.getElementById('directory-content');
        if (!tree) {
          container.innerHTML = '<div class="empty-state">No directory loaded</div>';
          return;
        }

        function renderNode(node) {
          if (node.kind === 'file') {
            return `<div class="file-item" onclick="selectFile('${node.path}')">${node.name}</div>`;
          } else {
            return `<div style="margin-left: 16px;">${node.name}/</div>`;
          }
        }

        function renderTree(node) {
          let html = renderNode(node);
          if (node.children) {
            html += node.children.map(renderTree).join('');
          }
          return html;
        }

        container.innerHTML = renderTree(tree);
      }

      function updateComments(comments) {
        const container = document.getElementById('comment-log');
        const counter = document.getElementById('comment-count');
        
        counter.textContent = comments.length;
        
        if (comments.length === 0) {
          container.innerHTML = '<div class="empty-state">No comments yet</div>';
          return;
        }

        container.innerHTML = comments.map(comment => `
          <div class="comment-item">
            <div class="comment-header">${comment.file}:${comment.line}</div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `).join('');
      }

      // Global functions for buttons
      window.generateUML = function() {
        const rootPath = prompt('Enter root path:', '/tmp/test-project');
        if (rootPath) {
          wsClient.generateUml(rootPath, 500);
        }
      };

      window.selectFile = function(filePath) {
        store.selectFile(filePath);
        
        // Update visual selection
        document.querySelectorAll('.file-item').forEach(item => {
          item.classList.remove('selected');
        });
        event.target.classList.add('selected');
        
        // Request file contents
        parent.postMessage({ 
          pluginMessage: { 
            type: 'get_file_contents', 
            filePath 
          } 
        }, '*');
      };

      window.exportComments = function() {
        const comments = store.state.comments;
        const exportData = JSON.stringify(comments, null, 2);
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'export_comments', 
            data: exportData 
          } 
        }, '*');
      };

      window.switchToWidget = function() {
        if (confirm('Switch to widget mode? This will close the plugin UI and create an embedded widget on the FigJam board.')) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'switch-to-widget'
            } 
          }, '*');
        }
      };

      // Message handler for plugin communication
      window.addEventListener('message', (event) => {
        const { type, ...data } = event.data.pluginMessage || {};
        
        switch (type) {
          case 'connection_update':
            store.setConnectionState(data.isConnected, data.channelName);
            break;
          case 'uml_diagram':
            store.setDiagram(data.diagram);
            if (data.directory) {
              store.setDirectoryTree(data.directory);
            }
            break;
          case 'file_contents':
            // Update code review panel with file contents
            const codeContent = document.getElementById('code-content');
            codeContent.innerHTML = `
              <div style="font-family: Monaco, monospace; font-size: 12px; line-height: 1.4;">
                <div style="background: #3d3d3d; padding: 4px 8px; margin-bottom: 8px; font-size: 11px;">
                  ${data.filePath}
                </div>
                <pre style="margin: 0; white-space: pre-wrap;">${data.content}</pre>
              </div>
            `;
            break;
        }
      });

      // Subscribe to store changes
      store.subscribe((state) => {
        updateConnectionStatus(state.isConnected, state.channelName);
        updateDirectoryTree(state.directoryTree);
        updateComments(state.comments);
      });

      // Initialize the UI
      createCodeReviewUI();
      
      // Try to connect
      wsClient.connect('ws://localhost:3055', 'code-review').then(() => {
        store.setConnectionState(true, 'code-review');
      }).catch(() => {
        store.setConnectionState(false, null);
      });
    </script>
  </body>
</html>